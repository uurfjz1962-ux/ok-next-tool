<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PC側</title>
<style>
body{
  margin:0;
  font-family:system-ui, sans-serif;
  background:#0b1220;
  color:#fff;
}
.wrap{max-width:900px;margin:auto;padding:24px}
.card{
  background:#121b2e;
  border-radius:16px;
  padding:20px;
}
input,button{
  font-size:18px;
  padding:12px;
  border-radius:12px;
  border:none;
}
input{width:220px}
button{background:#2563eb;color:#fff}
button:disabled{opacity:.4}
#big{
  font-size:36px;
  font-weight:800;
  margin:24px 0;
}
.red{color:#fb7185}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>PC側（1F）</h2>

    <input id="room" placeholder="部屋ID">
    <button id="connect">接続</button>

    <div id="status">未接続</div>

    <div id="big">地下の確認待ち</div>

    <button id="next" disabled>次のスイッチへ</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMgfoUE8UYwydCQzjOllwVHW7YRxd-IUE",
  authDomain: "ok-next-tool.firebaseapp.com",
  projectId: "ok-next-tool",
  storageBucket: "ok-next-tool.firebasestorage.app",
  messagingSenderId: "219936585310",
  appId: "1:219936585310:web:f40edd2d3b58d8d7aba6cf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const roomEl = document.getElementById("room");
const connectBtn = document.getElementById("connect");
const statusEl = document.getElementById("status");
const bigEl = document.getElementById("big");
const nextBtn = document.getElementById("next");

let roomRef=null;
let lastPhoneOk=0;

function norm(s){
  return (s||"").trim().toUpperCase().replace(/[^A-Z0-9_-]/g,"");
}

connectBtn.onclick = async ()=>{
  const id = norm(roomEl.value);
  if(!id) return alert("部屋IDを入れてください");

  roomRef = doc(db,"rooms",id);
  await setDoc(roomRef,{ phoneOk:0, pcNext:0 },{merge:true});

  statusEl.textContent = `接続中：${id}`;
  bigEl.textContent = "地下の確認待ち";
  bigEl.classList.remove("red");
  nextBtn.disabled = true;
  lastPhoneOk = 0;

  onSnapshot(roomRef,(snap)=>{
    const d = snap.data()||{};
    if(d.phoneOk > lastPhoneOk){
      bigEl.textContent = "確認OKが届きました";
      bigEl.classList.add("red");
      nextBtn.disabled = false;
    }
    lastPhoneOk = d.phoneOk||0;
  });
};

nextBtn.onclick = async ()=>{
  if(!roomRef) return;
  await updateDoc(roomRef,{ pcNext: increment(1) });
  bigEl.textContent = "地下の確認待ち";
  bigEl.classList.remove("red");
  nextBtn.disabled = true;
};
</script>
</body>
</html>
