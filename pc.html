<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PC - OK/次 連動</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; line-height: 1.5; }
    .row { margin: 12px 0; }
    input { font-size: 18px; padding: 10px; width: 220px; }
    button { font-size: 18px; padding: 10px 16px; }
    #status { padding: 10px; background: #f3f3f3; border-radius: 8px; }
    #big { font-size: 34px; font-weight: 800; margin: 18px 0 8px; }
    .muted { color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <h1>PC側</h1>

  <div class="row">
    部屋ID：
    <input id="room" maxlength="16" placeholder="例: ABCD" />
    <button id="connect">接続</button>
  </div>

  <div id="status" class="row">未接続</div>

  <div id="big"></div>

  <div class="row">
    <button id="next" disabled>次</button>
  </div>

  <div class="muted">
    ※ PC/スマホ両方で同じ部屋IDに接続してください（ログイン不要）
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, onSnapshot, setDoc, updateDoc, increment, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ★ここだけ自分の Firebase 設定に置き換える
    const firebaseConfig = {
  apiKey: "AIzaSyBMgfoUE8UYwydCQzjOllwVHW7YRxd-IUE",
  authDomain: "ok-next-tool.firebaseapp.com",
  projectId: "ok-next-tool",
  storageBucket: "ok-next-tool.firebasestorage.app",
  messagingSenderId: "219936585310",
  appId: "1:219936585310:web:f40edd2d3b58d8d7aba6cf"
};


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const roomEl = document.getElementById("room");
    const connectBtn = document.getElementById("connect");
    const statusEl = document.getElementById("status");
    const bigEl = document.getElementById("big");
    const nextBtn = document.getElementById("next");

    let unsub = null;
    let roomId = "";
    let roomRef = null;

    let lastPhoneOk = 0;

    function normalizeRoomId(s) {
      return (s || "").trim().toUpperCase().replace(/[^A-Z0-9_-]/g, "");
    }

    connectBtn.onclick = async () => {
      roomId = normalizeRoomId(roomEl.value);
      if (!roomId) return alert("部屋IDを入れてね（例: ABCD）");

      roomRef = doc(db, "rooms", roomId);

      await setDoc(roomRef, {
        phoneOkCount: 0,
        pcNextCount: 0,
        updatedAt: serverTimestamp()
      }, { merge: true });

      if (unsub) unsub();
      statusEl.textContent = `接続中：部屋 ${roomId}`;
      bigEl.textContent = "";
      nextBtn.disabled = true;

      unsub = onSnapshot(roomRef, (snap) => {
        const data = snap.data() || {};
        const phoneOk = Number(data.phoneOkCount || 0);

        if (phoneOk > lastPhoneOk) {
          bigEl.textContent = "OK 次";
          nextBtn.disabled = false;
        }
        lastPhoneOk = phoneOk;
      });
    };

    nextBtn.onclick = async () => {
      if (!roomRef) return;
      await updateDoc(roomRef, {
        pcNextCount: increment(1),
        updatedAt: serverTimestamp()
      });

      bigEl.textContent = "送信：次";
      nextBtn.disabled = true;
      setTimeout(() => { bigEl.textContent = ""; }, 800);
    };
  </script>
</body>
</html>
