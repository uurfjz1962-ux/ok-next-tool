<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>スマホ側</title>
<style>
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#07101f;
  color:#fff;
}
.wrap{max-width:500px;margin:auto;padding:20px}
.card{
  background:#101b33;
  border-radius:16px;
  padding:20px;
}
input,button{
  width:100%;
  font-size:20px;
  padding:14px;
  border-radius:14px;
  border:none;
}
button{background:#22c55e;color:#fff;font-weight:800}
button:disabled{opacity:.4}
#note{
  font-size:30px;
  font-weight:800;
  margin:20px 0;
}
.red{color:#fb7185}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>スマホ側（地下）</h2>

    <input id="room" placeholder="部屋ID">
    <button id="connect">接続</button>

    <div id="note">未接続</div>

    <button id="ok" disabled>確認できた（OK）</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMgfoUE8UYwydCQzjOllwVHW7YRxd-IUE",
  authDomain: "ok-next-tool.firebaseapp.com",
  projectId: "ok-next-tool",
  storageBucket: "ok-next-tool.firebasestorage.app",
  messagingSenderId: "219936585310",
  appId: "1:219936585310:web:f40edd2d3b58d8d7aba6cf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const roomEl=document.getElementById("room");
const connectBtn=document.getElementById("connect");
const okBtn=document.getElementById("ok");
const noteEl=document.getElementById("note");

let roomRef=null;
let lastPcNext=0;

function norm(s){
  return (s||"").trim().toUpperCase().replace(/[^A-Z0-9_-]/g,"");
}

connectBtn.onclick = async ()=>{
  const id=norm(roomEl.value);
  if(!id) return alert("部屋IDを入れてください");

  roomRef = doc(db,"rooms",id);
  await setDoc(roomRef,{ phoneOk:0, pcNext:0 },{merge:true});

  noteEl.textContent="PCの操作待ち";
  noteEl.classList.remove("red");
  okBtn.disabled=false;
  lastPcNext=0;

  onSnapshot(roomRef,(snap)=>{
    const d=snap.data()||{};
    if(d.pcNext > lastPcNext){
      noteEl.textContent="次へ";
      noteEl.classList.add("red");
    }
    lastPcNext = d.pcNext||0;
  });
};

okBtn.onclick = async ()=>{
  if(!roomRef) return;
  await updateDoc(roomRef,{ phoneOk: increment(1) });
  noteEl.textContent="PCの操作待ち";
  noteEl.classList.remove("red");
};
</script>
</body>
</html>
